'use strict';const express=require("express"),app=express(),router=express.Router(),faker=require("faker"),bcrypt=require("bcryptjs"),fs=require("fs"),User=require("../../models/User"),Todo=require("../../models/Todo"),{isEmpty}=require("../../helpers/upload-helpers");router.all("/*",(a,e,b)=>{a.app.locals.layout="admin";b()});router.get("/",(a,e)=>{User.find().then(b=>{e.render("admin/users",{users:b})}).catch(b=>console.log(b))});router.get("/create",(a,e)=>{e.render("admin/users/create")});
router.get("/dummy",(a,e)=>{e.render("admin/users/dummy")});router.get("/edit/:id",(a,e)=>{User.findOne({_id:a.params.id}).then(b=>{e.render("admin/users/edit",{user:b})}).catch(b=>console.log(b))});router.get("/show/:id",(a,e)=>{User.findOne({_id:a.params.id}).then(b=>{e.render("admin/users/show",{user:b})}).catch(b=>console.log(b))});
router.post("/create",(a,e)=>{User.findOne({email:a.body.email}).then(b=>{if(b)a.flash("error_msg","Email aleady exists ):");else{b="";if(!isEmpty(a.files)){let d=a.files.file;b=Date.now()+"-"+d.name;d.mv("./public/uploads/"+b,f=>{f&&console.log(f)})}const c=new User;c.fullname=a.body.fullname;c.email=a.body.email;c.phone=a.body.phone;c.role=a.body.role;c.status=a.body.status;c.file=b;bcrypt.genSalt(10,(d,f)=>{bcrypt.hash(a.body.password,f,(k,h)=>{c.password=h;c.save().then(g=>{a.flash("success_msg",
"User registered successfully :)");e.redirect("/admin/users")}).catch(g=>console.log(g))})})}}).catch(b=>console.log(b))});
router.post("/dummy",(a,e)=>{for(let b=0;b<a.body.number;b++){const c=new User;c.fullname=faker.name.firstName()+" "+faker.name.lastName();c.email=faker.internet.email();c.phone="080-000-0000-000";c.role="Subscriber";c.status="active";c.file="default.png";bcrypt.genSalt(10,(d,f)=>{bcrypt.hash("00000",f,(k,h)=>{c.password=h;c.save().then(g=>{a.flash("success_msg",`${a.body.number} dummy users has been generated :)`);e.redirect("/admin/users")}).catch(g=>console.log(g))})})}});
router.put("/update/:id",(a,e)=>{User.findOne({_id:a.params.id}).then(b=>{let c=b.file;if(!isEmpty(a.files)){let d=a.files.file;c=Date.now()+"-"+d.name;d.mv("./public/uploads/"+c,f=>{f&&console.log(f)});"default;png"!==b.file&&fs.unlink("./public/uploads/"+b.file,f=>{f&&console.log(f)})}a.body.password?(b.fullname=a.body.fullname,b.email=a.body.email,b.phone=a.body.phone,b.status=a.body.status,b.role=a.body.role,b.file=c,bcrypt.genSalt(10,(d,f)=>{bcrypt.hash(a.body.password,f,(k,h)=>{b.password=h;
b.save().then(g=>{a.flash("success_msg","Updated user successfully :)");e.redirect("/admin/users")}).catch(g=>console.log(g))})})):(b.fullname=a.body.fullname,b.email=a.body.email,b.phone=a.body.phone,b.status=a.body.status,b.role=a.body.role,b.file=c,b.save().then(d=>{a.flash("success_msg","Updated user successfully :)");e.redirect("/admin/users")}).catch(d=>console.log(d)))}).catch(b=>console.log(b))});
router.delete("/delete/:id",(a,e)=>{User.findOne({_id:a.params.id}).then(b=>{"default.png"!==b.file&&fs.unlink("./public/uploads/"+b.file,c=>{c&&console.log(c)});Todo.find({user:a.params.id}).then(c=>{c.forEach(d=>{"img_place.png"!==d.file&&fs.unlink("./public/uploads/"+d.file,f=>{f&&console.log(f)});d.delete().then(f=>{b.delete().then(k=>{a.flash("success_msg","Deleted user successfully :)");e.redirect("/admin/users")})})})}).catch(c=>console.log(c))})});
router.post("/multiaction",(a,e)=>{User.find({_id:a.body.checkboxes}).then(b=>{b.forEach(c=>{"active"==a.body.action?(c.status="active",c.save().then(d=>{a.flash("success_msg","Operation performed successfully :)");e.redirect("/admin/users")}).catch(d=>console.log(d))):"inactive"==a.body.action?(c.status="inactive",c.save().then(d=>{a.flash("success_msg","Operation performed successfully :)");e.redirect("/admin/users")}).catch(d=>console.log(d))):"delete"==a.body.action&&("default.png"!==c.file&&
fs.unlink("./public/uploads/"+c.file,d=>{d&&console.log(d)}),c.delete().then(d=>{a.flash("success_msg","Operation performed successfully :)");e.redirect("/admin/users")}).catch(d=>console.log(d)))})})});module.exports=router;