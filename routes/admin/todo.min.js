'use strict';const express=require("express"),app=express(),router=express.Router(),Todo=require("../../models/Todo"),User=require("../../models/User"),faker=require("faker"),fs=require("fs"),{isEmpty}=require("../../helpers/upload-helpers");router.all("/*",(b,c,a)=>{b.app.locals.layout="admin";a()});
router.get("/",(b,c)=>{"Admin"==b.user.role?Todo.find().then(a=>{c.render("admin/todos",{todos:a})}).catch(a=>console.log(a)):Todo.find({user:b.user}).then(a=>{c.render("admin/todos",{todos:a})}).catch(a=>console.log(a))});
router.get("/cancelled",(b,c)=>{"Admin"==b.user.role?Todo.find().where("status").equals(!1).then(a=>{c.render("admin/todos/cancelled",{todos:a})}).catch(a=>console.log(a)):Todo.find({user:b.user}).where("status").equals(!1).then(a=>{c.render("admin/todos/cancelled",{todos:a})}).catch(a=>console.log(a))});
router.get("/completed",(b,c)=>{"Admin"==b.user.role?Todo.find().where("completion_status").equals(!0).then(a=>{c.render("admin/todos/completed",{todos:a})}).catch(a=>console.log(a)):Todo.find({user:b.user}).where("completion_status").equals(!0).then(a=>{c.render("admin/todos/completed",{todos:a})}).catch(a=>console.log(a))});
router.get("/incompleted",(b,c)=>{"Admin"==b.user.role?Todo.find().where("completion_status").equals(!1).then(a=>{c.render("admin/todos/incompleted",{todos:a})}).catch(a=>console.log(a)):Todo.find({user:b.user}).where("completion_status").equals(!1).then(a=>{c.render("admin/todos/incompleted",{todos:a})}).catch(a=>console.log(a))});router.get("/create",(b,c)=>{c.render("admin/todos/create")});router.get("/dummy",(b,c)=>{c.render("admin/todos/dummy")});
router.get("/edit/:slug",(b,c)=>{Todo.findOne({slug:b.params.slug}).then(a=>{c.render("admin/todos/edit",{todo:a})}).catch(a=>console.log(a))});router.get("/show/:slug/",(b,c)=>{Todo.findOne({slug:b.params.slug}).then(a=>{c.render("admin/todos/show",{todo:a})}).catch(a=>console.log(a))});
router.post("/create",(b,c)=>{Todo.findOne({subject:b.body.subject}).then(a=>{if(a)"active"===a.status?b.flash("error_msg","Subject already exists with a todo that is active"):b.flash("error_msg","Subject already exists with a todo that is inactive"),c.redirect("back");else{a="";if(!isEmpty(b.files)){const d=b.files.file;a=Date.now()+"-"+d.name;d.mv("./public/uploads/"+a,e=>{e&&console.log(e)})}(new Todo({subject:b.body.subject,date:b.body.date,file:a,user:b.user,note:b.body.note})).save().then(d=>
{b.flash("success_msg","Todo saved successfully :)");c.redirect("/admin/todos")}).catch(d=>console.log(d))}}).catch(a=>console.log(a))});
router.put("/update/:slug",(b,c)=>{Todo.findOne({slug:b.params.slug}).then(a=>{let d=a.file;if(!isEmpty(b.files)){const e=b.files.file;d=Date.now()+"-"+e.name;e.mv("./public/uploads/"+d,f=>{f&&console.log(f)});"img_place.png"!==a.file&&fs.unlink("./public/uploads/"+a.file,f=>{f&&console.log(f)})}a.subject=b.body.subject;a.note=b.body.note;a.date=b.body.date;a.file=d;a.save().then(e=>{b.flash("success_msg","Successfully updated todo :)");c.redirect("/admin/todos")}).catch(e=>console.log(e))}).catch(a=>
console.log(a))});router.put("/status/:slug",(b,c)=>{Todo.findOne({slug:b.params.slug}).then(a=>{a.status=b.body.status;a.save().then(d=>{b.flash("success_msg","Successfully updated todo :)");c.redirect("/admin/todos")}).catch(d=>console.log(d))}).catch(a=>console.log(a))});
router.put("/completion_status/:slug",(b,c)=>{Todo.findOne({slug:b.params.slug}).then(a=>{a.completion_status=b.body.completion_status;a.save().then(d=>{b.flash("success_msg","Successfully updated todo :)");c.redirect("/admin/todos")}).catch(d=>console.log(d))}).catch(a=>console.log(a))});
router.post("/dummy",(b,c)=>{for(let a=0;a<b.body.number;a++)(new Todo({subject:faker.name.title(),date:new Date,completion_status:faker.random.boolean(),status:faker.random.boolean(),file:"img_place.png",user:b.user,note:faker.lorem.sentence()})).save().then(d=>{b.flash("success_msg",`${b.body.number} dummy todos saved :)`);c.redirect("/admin/todos")}).catch(d=>console.log(d))});
router.delete("/delete/:slug",(b,c)=>{Todo.findOne({slug:b.params.slug}).then(a=>{"img_place.png"!==a.file&&fs.unlink("./public/uploads/"+a.file,d=>{d&&console.log(d)});a.delete().then(d=>{b.flash("success_msg","Todo deleted successfully :)");c.redirect("/admin/todos")}).catch(d=>console.log(d))}).catch(a=>console.log(a))});
router.post("/multiaction",(b,c)=>{b.body.checkboxes||(b.flash("error_msg","No input checkboxes ):"),c.redirect("back"));Todo.find({_id:b.body.checkboxes}).then(a=>{a.forEach(d=>{"incomplete"==b.body.action?(d.completion_status=!1,d.save().then(e=>{b.flash("success_msg","Todos completion status changed to incompleted");c.redirect("/admin/todos/incompleted")})):"complete"==b.body.action?(d.completion_status=!0,d.save().then(e=>{b.flash("success_msg","Todos completion status changed to completed");
c.redirect("/admin/todos/completed")})):"retrieve"==b.body.action?(d.status=!0,d.save().then(e=>{b.flash("success_msg","Todos status changed to active");c.redirect("/admin/todos")})):"cancel"==b.body.action?(d.status=!1,d.save().then(e=>{b.flash("success_msg","Todos status changed to inactive");c.redirect("/admin/todos")})):"delete"==b.body.action?("img_place.png"!==d.file&&fs.unlink("./public/uploads/"+d.file,e=>{e&&console.log(e)}),d.delete().then(e=>{b.flash("success_msg","Todo deleted successfully :)");
c.redirect("/admin/todos")}).catch(e=>console.log(e))):(b.flash("success_msg","No operation to be handled :)"),c.redirect("/admin/todos"))})}).catch(a=>console.log(a))});router.post("/search",(b,c)=>{Todo.find({$or:[{subject:new RegExp(b.body.searched,"i")}]}).then(a=>{let d=Object.keys(a).length;c.render("admin/todos/searched",{todos:a,todosCount:d})}).catch(a=>console.log(a))});module.exports=router;