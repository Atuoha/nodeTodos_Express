'use strict';const express=require("express"),app=express(),router=express.Router(),User=require("../../models/User"),{isEmpty}=require("..//../helpers/upload-helpers"),bcrypt=require("bcryptjs"),fs=require("fs");router.all("/*",(b,c,a)=>{b.app.locals.layout="admin";a()});router.get("/",(b,c)=>{User.findOne({_id:b.user}).then(a=>{c.render("admin/profile",{profile:a})}).catch(a=>console.log(a))});
router.get("/edit",(b,c)=>{User.findOne({_id:b.user}).then(a=>{c.render("admin/profile/edit",{profile:a})}).catch(a=>console.log(a))});
router.put("/update",(b,c)=>{User.findOne({_id:b.user}).then(a=>{let d=a.file;if(!isEmpty(b.files)){let f=b.files.file;d=Date.now()+"-"+f.name;f.mv("./public/uploads/"+d,e=>{e&&console.log(e)});"default.png"!==a.file&&fs.unlink("./public/uploads/"+a.file,e=>{e&&console.log(e)})}b.body.password?(a.fullname=b.body.fullname,a.email=b.body.email,a.phone=b.body.phone,a.file=d,bcrypt.genSalt(10,(f,e)=>{bcrypt.hash(b.body.password,e,(k,h)=>{a.password=h;a.save().then(g=>{b.flash("success_msg","Updated profile successfully :)");
c.redirect("/admin/profile")}).catch(g=>console.log(g))})})):(a.fullname=b.body.fullname,a.email=b.body.email,a.phone=b.body.phone,a.file=d,a.save().then(f=>{b.flash("success_msg","Updated profile successfully :)");c.redirect("/admin/profile")}).catch(f=>console.log(f)))}).catch(a=>console.log(a))});
router.get("/unactivate",(b,c)=>{User.findOne({_id:b.user}).then(a=>{a.status="inactive";a.save().then(d=>{b.flash("success_msg","Profile unactivated successfully :)");c.redirect("/admin/profile")}).catch(d=>console.log(d))}).catch(a=>console.log(a))});module.exports=router;